---
title: 16-Spring Security oAuth2
time: 2020年9月3日

---

[toc]

## 一、Spring Security oAuth2 简介

### 1.1 什么是 oAuth

oAuth 协议为用户资源的授权提供了一个安全的、开放而有简易的标准。与以往的授权方式不同之处是，oAuth 的授权不会使第三方触及到用户的账号信息（如用户名和密码），也就是说，第三方无需使用用户的用户名与密码就可以申请并获得该用户资源的授权，因此 oAuth 是安全的。

### 1.2 什么是 Spring Security

Spring Security 是一个安全框架，前身是 Acegi Security，能够为 Spring 企业应用系统提供声明式的安全访问控制。Spring Security 基于 Servlet 过滤器、IoC 和 AOP，为 Web 请求和方法调用提供身份确认和授权处理，避免了代码耦合，减少了大量重复代码工作。

> oAuth2 是一种协议，具体的实现有：① Spring Security； ② oauth2-shiro

## 二、oAuth2

### 2.1 为什么需要 oAuth2

我们假设你有一个“云笔记”产品，并提供了“云笔记服务”和“云相册服务”，此时用户需要在不同的设备（PC、Android、iPhone、TV、Watch）上去访问这些“资源”（笔记，图片）

那么用户如何才能访问属于自己的那部分资源呢？此时传统的做法就是提供自己的账号和密码给我们的“云笔记”，登录成功后就可以获取资源了。但这样的做法会有以下几个问题：

- “云笔记服务”和“云相册服务”会分别部署，难道我们要分别登录吗？
- 如果有第三方应用程序想要接入我们的“云笔记”，难道需要用户提供账号和密码给第三方应用程序，让他记录后再访问我们的资源吗？
- 用户如何限制第三方应用程序在我们“云笔记”的授权范围和使用期限？难道把所有资料都永久暴露给它吗？
- 如果用户修改了密码收回了权限，那么所有第三方应用程序会全部失效。
- 只要有一个接入的第三方应用程序遭到破解，那么用户的密码就会泄露，后果不堪设想。

为了解决如上问题，oAuth 应用而生。

### 2.2 名词解释

- **第三方应用程序（Third-party application）：** 又称之为客户端（client），比如上节中提到的设备（PC、Android、iPhone、TV、Watch），我们会在这些设备中安装我们自己研发的 APP。又比如我们的产品想要使用 QQ、微信等第三方登录。对我们的产品来说，QQ、微信登录是第三方登录系统。我们又需要第三方登录系统的资源（头像、昵称等）。对于 QQ、微信等系统我们又是第三方应用程序。
- **HTTP 服务提供商（HTTP service）：** 我们的云笔记产品以及 QQ、微信等都可以称之为“服务提供商”。
- **资源所有者（Resource Owner）：** 又称之为用户（user）。
- **用户代理（User Agent）：** 比如浏览器，代替用户去访问这些资源。
- **认证服务器（Authorization server）：** 即服务提供商专门用来处理认证的服务器，简单点说就是登录功能（验证用户的账号密码是否正确以及分配相应的权限）
- **资源服务器（Resource server）：** 即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。简单点说就是资源的访问入口，比如上节中提到的“云笔记服务”和“云相册服务”都可以称之为资源服务器。

![image-20200510124130587](16-Spring-Security-oAuth2.assets/image-20200510124130587.png)

> 简单来说，就是服务消费方想要访问『服务提供方』的资源，但是『提供方』需要对『消费方』进行验证，同时又不能把自己的账号密码提供给『消费方』，此时就诞生了 oAuth2 协议；这个协议通过在『提供方』实现一些动作，然后将认证和授权信息返回给『消费方』，从而达到上述的标准。

### 2.3 交互过程

oAuth 在 "客户端" 与 "服务提供商" 之间，设置了一个授权层（authorization layer）。"客户端" 不能直接登录 "服务提供商"，只能登录授权层，以此将用户与客户端区分开来。"客户端" 登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。"客户端" 登录授权层以后，"服务提供商" 根据令牌的权限范围和有效期，向 "客户端" 开放用户储存的资料。

![img](16-Spring-Security-oAuth2.assets/Lusifer_201904010001.png)

> 着重观察（客户端、认证服务器以及资源服务器）三者，就可以了解到：『认证服务器』的设置，利用了 AOP 的思想，『认证服务器』有两个作用：认证与授权。所以，在用户请求『资源服务器』之前，会先发出两个请求，这两个请求的作用就是“认证”与“授权”。
>
> 本质上，oAuth2 协议就是将原来“在资源服务器”上做的认证与授权，分离出来一个『认证服务器』专门来实现。然后『认证服务器』会返回一个“令牌”，从而让『资源服务器』确认身份。

